{% extends "base.html" %}

{% block title %}Milestone {{ child.name if child.name else child[1] }} - BabyGrow{% endblock %}

{% block content %}
<div class="container animate-fadeIn">
    {% set child_id = child.id if child.id else child[0] %}
    {% set child_name = child.name if child.name else child[1] %}
    
    <!-- Header -->
    <div class="flex justify-between items-center" style="margin-bottom: var(--space-xl);">
        <div>
            <a href="{{ url_for('children.view_child', child_id=child_id) }}" class="text-muted" style="display: inline-flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-sm);">
                <i class="bi bi-arrow-left"></i> Kembali ke {{ child_name }}
            </a>
            <h1 style="margin-bottom: 0;">ðŸŽ¯ Milestone Perkembangan</h1>
        </div>
        <a href="{{ url_for('health.add_milestone', child_id=child_id) }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Tambah Milestone
        </a>
    </div>
    
    {% if milestones %}
    <!-- Overall Progress -->
    <div class="card" style="margin-bottom: var(--space-xl); background: linear-gradient(135deg, var(--color-mint) 0%, var(--color-cloud) 100%);">
        <div class="flex items-center justify-between">
            <div>
                <h3 style="margin: 0;">Progress Keseluruhan</h3>
                <p class="text-muted">{{ overall_progress }}% milestone tercapai</p>
            </div>
            <div class="progress-circle">
                <svg width="80" height="80" viewBox="0 0 80 80">
                    <circle class="progress-circle-bg" cx="40" cy="40" r="36"></circle>
                    <circle class="progress-circle-fill" cx="40" cy="40" r="36"
                            stroke-dasharray="{{ (overall_progress * 226) / 100 }} 226"></circle>
                </svg>
                <div class="progress-circle-text">{{ overall_progress }}%</div>
            </div>
        </div>
    </div>
    
    <!-- Milestones by Category -->
    {% for cat_key, cat_name in categories.items() %}
        {% set cat_items = milestones|selectattr('category', 'equalto', cat_key)|list if milestones[0].category is defined else [] %}
        {% if progress[cat_key].total > 0 %}
        <div class="card" style="margin-bottom: var(--space-md);">
            <div class="flex justify-between items-center" style="margin-bottom: var(--space-md);">
                <h3 style="margin: 0;">{{ cat_name }}</h3>
                <span class="badge badge-success">{{ progress[cat_key].done }}/{{ progress[cat_key].total }}</span>
            </div>
            <div class="progress" style="margin-bottom: var(--space-md);">
                <div class="progress-bar" style="width: {{ (progress[cat_key].done / progress[cat_key].total * 100) if progress[cat_key].total > 0 else 0 }}%;"></div>
            </div>
        </div>
        {% endif %}
    {% endfor %}
    
    <!-- All Milestones List -->
    <div class="card">
        <h3><i class="bi bi-list-check"></i> Semua Milestone</h3>
        <ul style="list-style: none; padding: 0; margin: var(--space-md) 0 0 0;">
            {% for m in milestones %}
            {% set m_id = m.id if m.id else m[0] %}
            {% set m_milestone = m.milestone if m.milestone else m[2] %}
            {% set m_status = m.status if m.status else m[3] %}
            {% set m_noted = m.noted if m.noted else m[5] %}
            <li class="flex items-center justify-between" style="padding: var(--space-md) 0; border-bottom: 1px solid var(--color-peach);">
                <div class="flex items-center gap-md">
                    <form method="POST" action="{{ url_for('health.toggle_milestone', child_id=child_id, milestone_id=m_id) }}">
                        <button type="submit" class="btn btn-icon {{ 'btn-success' if m_status == 'done' else 'btn-outline' }}">
                            {% if m_status == 'done' %}
                                <i class="bi bi-check-lg"></i>
                            {% else %}
                                <i class="bi bi-circle"></i>
                            {% endif %}
                        </button>
                    </form>
                    <div>
                        <strong style="{{ 'text-decoration: line-through; opacity: 0.6;' if m_status == 'done' }}">{{ m_milestone }}</strong>
                        {% if m_noted %}
                        <div class="text-sm text-muted">{{ m_noted }}</div>
                        {% endif %}
                    </div>
                </div>
                {% if m_status == 'done' %}
                <span class="badge badge-success">âœ“ Tercapai</span>
                {% else %}
                <span class="badge badge-pending">Belum</span>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="card empty-state">
        <div class="empty-state-icon">ðŸŽ¯</div>
        <h3 class="empty-state-title">Belum ada milestone</h3>
        <p class="empty-state-text">Catat pencapaian perkembangan {{ child_name }} seperti tengkurap, duduk, berjalan, dll.</p>
        <a href="{{ url_for('health.add_milestone', child_id=child_id) }}" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-circle"></i> Tambah Milestone Pertama
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
