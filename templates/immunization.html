{% extends 'base.html' %}

{% block title %}Imunisasi {{ child.name if child.name else child[1] }} - BabyGrow{% endblock %}

{% block content %}
<div class="container animate-fadeIn">
    {% set child_id = child.id if child.id else child[0] %}
    {% set child_name = child.name if child.name else child[1] %}
    
    <!-- Header -->
    <div class="flex justify-between items-center" style="margin-bottom: var(--space-xl);">
        <div>
            <a href="{{ url_for('children') }}" class="text-muted" style="display: inline-flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-sm);">
                <i class="bi bi-arrow-left"></i> Kembali ke Daftar
            </a>
            <h1 style="margin-bottom: 0;">ðŸ’‰ Imunisasi {{ child_name }}</h1>
        </div>
        <a href="{{ url_for('add_immunization', child_id=child_id) }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Tambah Vaksin
        </a>
    </div>
    
    {% if vaccinations %}
    <!-- Progress Card -->
    <div class="card" style="margin-bottom: var(--space-xl); background: linear-gradient(135deg, var(--color-blush) 0%, var(--color-cloud) 100%);">
        <div class="flex items-center justify-between">
            <div>
                <h3 style="margin: 0;">Status Imunisasi</h3>
                {% set total = vaccinations|length %}
                {% set done = vaccinations|selectattr('status', 'equalto', 'done')|list|length if vaccinations[0].status is defined else 0 %}
                {% set progress = ((done / total * 100) if total > 0 else 0)|int %}
                <p class="text-muted">{{ done }} dari {{ total }} vaksin selesai</p>
            </div>
            <div class="progress-circle">
                <svg width="80" height="80" viewBox="0 0 80 80">
                    <circle class="progress-circle-bg" cx="40" cy="40" r="36"></circle>
                    <circle class="progress-circle-fill" cx="40" cy="40" r="36"
                            stroke-dasharray="{{ (progress * 226) / 100 }} 226"
                            style="stroke: var(--color-blush);"></circle>
                </svg>
                <div class="progress-circle-text">{{ progress }}%</div>
            </div>
        </div>
    </div>
    
    <!-- Vaccination List -->
    <div class="card">
        <h3><i class="bi bi-list-ul"></i> Daftar Vaksinasi</h3>
        <ul style="list-style: none; padding: 0; margin: var(--space-md) 0 0 0;">
            {% for v in vaccinations %}
            {% set v_id = v.id if v.id else v[0] %}
            {% set v_vaccine = v.vaccine if v.vaccine else v[1] %}
            {% set v_date = v.date_given if v.date_given else v[2] %}
            {% set v_status = v.status if v.status else v[3] %}
            <li class="flex items-center justify-between" style="padding: var(--space-md) 0; border-bottom: 1px solid var(--color-peach);">
                <div class="flex items-center gap-md">
                    <form method="POST" action="{{ url_for('toggle_immunization', child_id=child_id, vacc_id=v_id) }}">
                        <button type="submit" class="btn btn-icon {{ 'btn-success' if v_status == 'done' else 'btn-outline' }}">
                            {% if v_status == 'done' %}
                                <i class="bi bi-check-lg"></i>
                            {% else %}
                                <i class="bi bi-circle"></i>
                            {% endif %}
                        </button>
                    </form>
                    <div>
                        <strong>{{ v_vaccine }}</strong>
                        {% if v_date %}
                        <div class="text-sm text-muted">Diberikan: {{ v_date }}</div>
                        {% endif %}
                    </div>
                </div>
                {% if v_status == 'done' %}
                <span class="badge badge-success">âœ“ Selesai</span>
                {% else %}
                <span class="badge badge-warning">Pending</span>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="card empty-state">
        <div class="empty-state-icon">ðŸ’‰</div>
        <h3 class="empty-state-title">Belum ada data vaksinasi</h3>
        <p class="empty-state-text">Catat riwayat imunisasi {{ child_name }}</p>
        <a href="{{ url_for('add_immunization', child_id=child_id) }}" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-circle"></i> Tambah Vaksin Pertama
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
