{% extends 'base.html' %}

{% block title %}{{ capsule.title if capsule.title else capsule[2] }} - BabyGrow{% endblock %}

{% block content %}
<div class="container animate-fadeIn">
    <div style="max-width: 700px; margin: 0 auto;">
        {% set cap_id = capsule.id if capsule.id else capsule[0] %}
        {% set cap_title = capsule.title if capsule.title else capsule[2] %}
        {% set cap_content = capsule.letter_content if capsule.letter_content else capsule[3] %}
        {% set cap_unlock = capsule.unlock_date if capsule.unlock_date else capsule[4] %}
        {% set cap_occasion = capsule.unlock_occasion if capsule.unlock_occasion else capsule[5] %}
        {% set cap_child = capsule.child_name if capsule.child_name else capsule[10] %}
        
        <a href="{{ url_for('capsule_list') }}" class="text-muted" style="display: inline-flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-md);">
            <i class="bi bi-arrow-left"></i> Kembali ke Daftar Kapsul
        </a>
        
        <div class="card capsule-card">
            <div style="text-align: center; margin-bottom: var(--space-lg);">
                <div style="font-size: 3rem; margin-bottom: var(--space-sm);">‚úâÔ∏è</div>
                <span class="badge badge-warning">üìù Draft - Belum Disegel</span>
            </div>
            
            <form method="POST" action="{{ url_for('capsule_update', capsule_id=cap_id) }}">
                <div class="form-group">
                    <label class="form-label">Judul Kapsul</label>
                    <input type="text" name="title" class="form-input" value="{{ cap_title }}" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Untuk: {{ cap_child }}</label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Surat Cinta üíå</label>
                    <textarea name="letter_content" class="form-textarea letter-editor" rows="12">{{ cap_content or '' }}</textarea>
                </div>
                
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Tanggal Dibuka</label>
                        <input type="date" name="unlock_date" class="form-input" value="{{ cap_unlock }}" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Momen Spesial</label>
                        <input type="text" name="unlock_occasion" class="form-input" value="{{ cap_occasion or '' }}" placeholder="misal: Ulang Tahun ke-17">
                    </div>
                </div>
                
                <div class="flex gap-md" style="margin-top: var(--space-lg);">
                    <button type="submit" class="btn btn-secondary btn-lg" style="flex: 1;">
                        <i class="bi bi-save"></i> Simpan Perubahan
                    </button>
                </div>
            </form>
            
            <hr style="margin: var(--space-xl) 0; border: none; border-top: 2px dashed var(--color-peach);">
            
            <!-- Photo Upload Section -->
            <div style="margin-bottom: var(--space-xl);">
                <h3><i class="bi bi-camera"></i> Tambah Foto Kenangan</h3>
                
                {% if media %}
                <div class="upload-preview" style="margin-bottom: var(--space-lg);">
                    {% for m in media %}
                    {% set m_url = m.file_url if m.file_url else m[3] %}
                    {% set m_type = m.media_type if m.media_type else m[2] %}
                    {% set m_caption = m.caption if m.caption else m[5] %}
                    {% if m_type == 'photo' %}
                    <div class="polaroid-card">
                        <img src="{{ m_url }}" alt="{{ m_caption }}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: var(--radius-sm);">
                        {% if m_caption %}
                        <p class="text-sm text-center" style="margin-top: var(--space-xs);">{{ m_caption }}</p>
                        {% endif %}
                    </div>
                    {% elif m_type == 'audio' %}
                    <div class="audio-card" style="background: var(--color-mint); padding: var(--space-md); border-radius: var(--radius-md); text-align: center;">
                        <div style="font-size: 2rem;">üéôÔ∏è</div>
                        <p class="text-sm" style="margin: var(--space-xs) 0;">{{ m_caption or 'Rekaman Suara' }}</p>
                        <audio controls src="{{ m_url }}" style="width: 100%; max-width: 200px;"></audio>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
                
                <form method="POST" action="{{ url_for('capsule_upload_media', capsule_id=cap_id) }}" enctype="multipart/form-data">
                    <div class="upload-area" onclick="document.getElementById('photoInput').click();">
                        <i class="bi bi-cloud-arrow-up"></i>
                        <p class="text-muted">Klik untuk upload foto</p>
                        <input type="file" id="photoInput" name="photo" accept="image/*" style="display: none;" onchange="this.form.submit();">
                    </div>
                </form>
            </div>
            
            <!-- Audio Recording Section -->
            <div style="margin-bottom: var(--space-xl);">
                <h3><i class="bi bi-mic"></i> Rekam Suara Si Kecil</h3>
                <p class="text-muted" style="margin-bottom: var(--space-md);">Abadikan tangisan pertama, tawa, atau kata-kata manis</p>
                <a href="{{ url_for('capsule_audio', capsule_id=cap_id) }}" class="btn btn-outline-primary btn-lg" style="width: 100%;">
                    <i class="bi bi-mic"></i> Buka Perekam Suara
                </a>
            </div>
            
            <hr style="margin: var(--space-xl) 0; border: none; border-top: 2px dashed var(--color-peach);">
            
            <div class="text-center">
                <h3>üîê Segel Kapsul</h3>
                <p class="text-muted" style="margin-bottom: var(--space-md);">
                    Setelah disegel, kapsul tidak bisa diedit dan hanya bisa dibuka pada tanggal <strong>{{ cap_unlock }}</strong>
                </p>
                <form id="seal-form" method="POST" action="{{ url_for('capsule_seal', capsule_id=cap_id) }}">
                    <button type="button" id="seal-btn" class="btn btn-primary btn-lg">
                        <i class="bi bi-lock"></i> Segel Kapsul Sekarang
                    </button>
                </form>
            </div>
            
            <hr style="margin: var(--space-xl) 0; border: none; border-top: 1px solid var(--color-peach);">
            
            <div class="text-center">
                <form method="POST" action="{{ url_for('capsule_delete', capsule_id=cap_id) }}" 
                      onsubmit="return confirm('Yakin ingin menghapus kapsul ini?');">
                    <button type="submit" class="btn btn-ghost" style="color: var(--color-error);">
                        <i class="bi bi-trash"></i> Hapus Kapsul
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Seal button with celebration
    document.getElementById('seal-btn')?.addEventListener('click', function() {
        if (confirm('Yakin ingin menyegel kapsul ini? Setelah disegel, tidak bisa diedit lagi.')) {
            // Trigger celebration if available
            if (typeof celebrate === 'function') {
                celebrate('seal');
            }
            // Submit the form after a short delay for animation
            setTimeout(() => {
                document.getElementById('seal-form').submit();
            }, 500);
        }
    });
</script>
{% endblock %}

